<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Car Detection Counter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.11.0/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: #cbd5e1;
        }

        .status {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #bfdbfe;
        }

        .status.loading {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fde68a;
        }

        .status.ready {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #bbf7d0;
        }

        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
        }

        video, canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .video-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1e293b;
        }

        .video-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            color: #fecaca;
        }

        .hidden {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .stat-card.green {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
        }

        .stat-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: bold;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: #16a34a;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: #15803d;
        }

        .btn-stop {
            background: #dc2626;
            color: white;
        }

        .btn-stop:hover {
            background: #b91c1c;
        }

        .btn-reset {
            background: #6366f1;
            color: white;
        }

        .btn-reset:hover {
            background: #4f46e5;
        }

        .instructions {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 30px;
        }

        .instructions h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #cbd5e1;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        .instructions .note {
            margin-top: 20px;
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .stat-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                AI Car Detection Counter
            </h1>
            <p>Automatic real-time car detection and counting</p>
        </div>

        <div id="status" class="status loading">
            Loading AI model... Please wait.
        </div>

        <div id="error" class="error hidden"></div>

        <div class="video-container">
            <div id="placeholder" class="video-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                    <circle cx="12" cy="13" r="3"></circle>
                </svg>
                <p>Camera is off</p>
                <p style="font-size: 0.9rem; color: #64748b; margin-top: 10px;">Press Start Detection to begin</p>
            </div>
            <div id="canvasWrapper" class="canvas-wrapper hidden">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Cars Detected</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">Currently Visible</div>
                <div class="stat-value" id="currentCount">0</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-label">Detection Confidence</div>
                <div class="stat-value" id="confidence">0%</div>
            </div>
        </div>

        <div class="control-buttons">
            <button class="btn btn-start" id="startBtn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Start Detection
            </button>
            <button class="btn btn-stop hidden" id="stopBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="6" width="12" height="12"></rect>
                </svg>
                Stop Detection
            </button>
            <button class="btn btn-reset" id="resetBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                </svg>
                Reset Count
            </button>
        </div>

        <div class="instructions">
            <h3>How It Works:</h3>
            <ul>
                <li><strong>AI-Powered Detection:</strong> Uses TensorFlow.js and COCO-SSD model to detect cars in real-time</li>
                <li><strong>Automatic Counting:</strong> Counts unique cars as they enter the camera view</li>
                <li><strong>Live Tracking:</strong> Shows bounding boxes around detected cars</li>
                <li><strong>Accuracy:</strong> Works best with clear camera view and good lighting</li>
            </ul>
            <div class="note">
                <strong>ðŸ“Œ Tips for Best Results:</strong><br>
                â€¢ Position camera to capture full vehicle view<br>
                â€¢ Ensure good lighting conditions<br>
                â€¢ Keep camera steady for accurate tracking<br>
                â€¢ The model can detect cars, trucks, buses, and motorcycles
            </div>
        </div>
    </div>

    <script>
        let model = null;
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;
        let isDetecting = false;
        let totalCount = 0;
        let trackedCars = new Map();
        let nextCarId = 1;

        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const placeholder = document.getElementById('placeholder');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const totalCountEl = document.getElementById('totalCount');
        const currentCountEl = document.getElementById('currentCount');
        const confidenceEl = document.getElementById('confidence');

        // Load the model
        async function loadModel() {
            try {
                statusDiv.textContent = 'Loading AI model... Please wait.';
                statusDiv.className = 'status loading';
                model = await cocoSsd.load();
                statusDiv.textContent = 'âœ“ AI Model Ready! Click Start Detection to begin.';
                statusDiv.className = 'status ready';
                startBtn.disabled = false;
            } catch (err) {
                showError('Failed to load AI model. Please refresh the page.');
                statusDiv.classList.add('hidden');
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    placeholder.classList.add('hidden');
                    canvasWrapper.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    isDetecting = true;
                    detectFrame();
                };
                
                hideError();
            } catch (err) {
                showError('Camera access denied. Please allow camera permissions.');
            }
        }

        function stopCamera() {
            isDetecting = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            placeholder.classList.remove('hidden');
            canvasWrapper.classList.add('hidden');
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            trackedCars.clear();
            currentCountEl.textContent = '0';
        }

        function calculateIoU(box1, box2) {
            const x1 = Math.max(box1.x, box2.x);
            const y1 = Math.max(box1.y, box2.y);
            const x2 = Math.min(box1.x + box1.width, box2.x + box2.width);
            const y2 = Math.min(box1.y + box1.height, box2.y + box2.height);

            const intersection = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
            const area1 = box1.width * box1.height;
            const area2 = box2.width * box2.height;
            const union = area1 + area2 - intersection;

            return intersection / union;
        }

        async function detectFrame() {
            if (!isDetecting) return;

            const predictions = await model.detect(video);
            
            // Filter for vehicles
            const vehicles = predictions.filter(p => 
                ['car', 'truck', 'bus', 'motorcycle'].includes(p.class)
            );

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.font = '18px Arial';
            ctx.fillStyle = '#00ff00';

            let avgConfidence = 0;
            const currentFrameCars = new Set();

            vehicles.forEach(prediction => {
                const [x, y, width, height] = prediction.bbox;
                const box = { x, y, width, height };
                
                // Try to match with existing tracked cars
                let matched = false;
                for (let [id, trackedBox] of trackedCars) {
                    if (calculateIoU(box, trackedBox) > 0.3) {
                        trackedCars.set(id, box);
                        currentFrameCars.add(id);
                        matched = true;
                        break;
                    }
                }

                // New car detected
                if (!matched) {
                    const newId = nextCarId++;
                    trackedCars.set(newId, box);
                    currentFrameCars.add(newId);
                    totalCount++;
                    totalCountEl.textContent = totalCount;
                }

                // Draw bounding box
                ctx.strokeRect(x, y, width, height);
                ctx.fillText(
                    `${prediction.class} ${Math.round(prediction.score * 100)}%`,
                    x,
                    y > 20 ? y - 5 : y + 20
                );

                avgConfidence += prediction.score;
            });

            // Remove cars that are no longer visible
            for (let id of trackedCars.keys()) {
                if (!currentFrameCars.has(id)) {
                    trackedCars.delete(id);
                }
            }

            // Update stats
            currentCountEl.textContent = trackedCars.size;
            if (vehicles.length > 0) {
                confidenceEl.textContent = Math.round((avgConfidence / vehicles.length) * 100) + '%';
            }

            requestAnimationFrame(detectFrame);
        }

        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        resetBtn.addEventListener('click', () => {
            totalCount = 0;
            nextCarId = 1;
            trackedCars.clear();
            totalCountEl.textContent = '0';
            currentCountEl.textContent = '0';
            confidenceEl.textContent = '0%';
        });

        // Load model on page load
        loadModel();
    </script>
</body>
</html>